<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8" />
    <title>Resultados das Votações</title>
    <style>
        body {
          font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
          margin: 30px auto;
          max-width: 800px;
          color: #333;
          font-size: 14px;
        }
        h1 {
          text-align: center;
          font-size: 22px;
          margin-bottom: 1em;
          color: #2a7b2a;
        }
        h2 {
          font-size: 16px;
          margin-top: 1.5em;
          cursor: pointer;
          display: flex;
          align-items: center;
          justify-content: space-between;
          background: #f0f0f0;
          padding: 10px 14px;
          border-radius: 6px;
        }
        .toggle-btn {
          font-size: 12px;
          background: #2a7b2a;
          color: white;
          border: none;
          padding: 4px 8px;
          border-radius: 4px;
          cursor: pointer;
        }
        .votacao {
          margin: 10px 0;
          padding: 10px 14px;
          border: 1px solid #ccc;
          border-radius: 6px;
          background-color: #fafafa;
          box-shadow: 1px 1px 3px rgba(0,0,0,0.05);
        }
        .votacao span {
          display: block;
          margin-bottom: 4px;
          font-size: 13px;
        }
        #formulario-voto {
          display: none;
          border: 1px solid #ccc;
          padding: 20px;
          background-color: #fefefe;
          margin-bottom: 20px;
          border-radius: 6px;
        }
        #loading {
          display: none;
          text-align: center;
          margin: 20px 0;
        }
        .loader {
          border: 4px solid #f3f3f3;
          border-top: 4px solid #2a7b2a;
          border-radius: 50%;
          width: 30px;
          height: 30px;
          animation: spin 1s linear infinite;
          display: inline-block;
          vertical-align: middle;
        }
        @keyframes spin {
          0% { transform: rotate(0deg); }
          100% { transform: rotate(360deg); }
        }
        #btn-next {
          margin-top: 10px;
          display: block;
          text-align: center;
          padding: 8px 14px;
          background: #2a7b2a;
          color: white;
          border: none;
          border-radius: 5px;
          cursor: pointer;
        }
    </style>
</head>
<body>

<h1>Lista de Votações</h1>

<!-- Formulário de voto -->
<div id="formulario-voto">
    <h2>Votar nesta Pauta</h2>
    <form method="POST" action="/votacao/votar-form">
        <input type="hidden" name="codigoAssembleia" id="codigoAssembleiaInput">
        <input type="hidden" name="codigoPauta" id="codigoPautaInput">
        <input type="hidden" name="codigo" id="codigoVotacaoInput">

        <label for="codigoAssociado">Associado:</label>
        <select name="codigoAssociado" id="codigoAssociado" required>
            <option value="">Carregando...</option>
        </select>

        <div style="margin-top: 10px;">
            <label><input type="radio" name="voto" value="SIM" required> Sim</label>
            <label style="margin-left: 20px;"><input type="radio" name="voto" value="NAO"> Não</label>
        </div>

        <button type="submit" style="margin-top: 10px;">Enviar Voto</button>
    </form>
</div>

<h2 onclick="toggleSection('abertas')">
    Votações Abertas
    <button class="toggle-btn" id="btn-abertas">Recolher</button>
</h2>
<div id="abertas"></div>

<h2 onclick="toggleSection('encerradas', true)">
    Votações Encerradas
    <button class="toggle-btn" id="btn-encerradas">Expandir</button>
</h2>
<div id="encerradas" style="display: none;"></div>

<!-- Loader -->
<div id="loading">
    <span class="loader"></span>
    <span style="margin-left: 10px;">Carregando...</span>
</div>

<script>
    let paginaAtual = 0;
    let encerradasCarregadas = false;

    function toggleSection(id, carregarSeExpandir = false) {
      const container = document.getElementById(id);
      const btn = document.getElementById('btn-' + id);
      const isHidden = container.style.display === 'none';

      if (isHidden && carregarSeExpandir && !encerradasCarregadas) {
        carregarVotacoesEncerradas();
      }

      container.style.display = isHidden ? 'block' : 'none';
      btn.textContent = isHidden ? 'Recolher' : 'Expandir';
    }

    function irParaVotacao(codigoVotacao, codigoPauta, codigoAssembleia) {
      const url = `http://localhost:8093/formulario.html?codigoVotacao=${codigoVotacao}&codigoPauta=${codigoPauta}&codigoAssembleia=${codigoAssembleia}`;
      window.location.href = url;
    }

    async function carregarAssociados(codigoPauta) {
      try {
        const response = await fetch(`/associados-habilitados?codigoPauta=${codigoPauta}`);
        const associados = await response.json();
        const select = document.getElementById('codigoAssociado');
        select.innerHTML = '<option value="">Selecione</option>';
        associados.forEach(a => {
          const opt = document.createElement('option');
          opt.value = a.codigo;
          opt.textContent = a.nome;
          select.appendChild(opt);
        });
      } catch (e) {
        console.error('Erro ao carregar associados:', e);
      }
    }

    async function carregarVotacoesAbertas() {
      document.getElementById('loading').style.display = 'block';
      const response = await fetch(`/votacao/lista-abertas`);
      const data = await response.json();
      const container = document.getElementById('abertas');

      data.forEach(v => {
        container.innerHTML += `
          <div class="votacao">
            <span><strong>Votação nº:</strong> ${v.codigo}</span>
            <span><strong>Assembléia nº:</strong> ${v.codigoAssembleia} - ${v.descricaoAssembleia}</span>
            <span><strong>Pauta:</strong> ${v.codigoPauta} - ${v.descricaoPauta}</span>
            <span><strong>Início:</strong> ${v.dataHoraInicio}</span>
            <span><strong>Fim Previsto:</strong> ${v.dataHoraEncerramento}</span>
            <span><strong>Status:</strong> ${v.status}</span>
            <button onclick="irParaVotacao('${v.codigo}', '${v.codigoPauta}', '${v.codigoAssembleia}')">Votar</button>
          </div>
        `;
      });

      document.getElementById('loading').style.display = 'none';
    }

    async function carregarVotacoesEncerradas() {
      encerradasCarregadas = true;
      document.getElementById('loading').style.display = 'block';
      const response = await fetch(`/votacao/lista-encerradas`);
      const data = await response.json();
      const container = document.getElementById('encerradas');

      data.forEach(v => {
        container.innerHTML += `
          <div class="votacao">
            <span><strong>Votação nº:</strong> ${v.codigo}</span>
            <span><strong>Assembléia nº:</strong> ${v.codigoAssembleia} - ${v.descricaoAssembleia}</span>
            <span><strong>Pauta:</strong> ${v.codigoPauta} - ${v.descricaoPauta}</span>
            <span><strong>Início:</strong> ${v.dataHoraInicio}</span>
            <span><strong>Encerramento:</strong> ${v.dataHoraEncerramento}</span>
            <span><strong>Votos Sim:</strong> ${v.votosSim}</span>
            <span><strong>Votos Não:</strong> ${v.votosNao}</span>
            <span><strong>Total de Votos:</strong> ${v.quantidadeVotos}</span>
            <span><strong>Resultado:</strong> ${v.resultado}</span>
            <span><strong>Percentual:</strong> ${v.percentual?.toFixed(2) || 0}%</span>
            <span><strong>Status:</strong> ${v.status}</span>
          </div>
        `;
      });
      document.getElementById('loading').style.display = 'none';
    }

    window.addEventListener("load", () => {
      const params = new URLSearchParams(window.location.search);
      const codigoVotacao = params.get("codigoVotacao");
      const codigoPauta = params.get("codigoPauta");
      const codigoAssembleia = params.get("codigoAssembleia");

      if (codigoVotacao && codigoPauta && codigoAssembleia) {
        document.getElementById("formulario-voto").style.display = "block";
        document.getElementById("codigoVotacaoInput").value = codigoVotacao;
        document.getElementById("codigoPautaInput").value = codigoPauta;
        document.getElementById("codigoAssembleiaInput").value = codigoAssembleia;
        carregarAssociados(codigoPauta);
      }
      carregarVotacoesAbertas();
    });
</script>
</body>
</html>
